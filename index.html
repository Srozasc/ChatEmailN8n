<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente de Cartera Deteriorada BCI</title>
    <style>
        /* --- ESTILOS GENERALES (SIN CAMBIOS) --- */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');
        :root { --color-primario: #007BFF; --color-secundario: #0056b3; --color-texto: #333; --color-fondo: #f4f7f6; --color-blanco: #ffffff; --sombra-suave: 0 4px 15px rgba(0, 0, 0, 0.1); }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--color-fondo); color: var(--color-texto); line-height: 1.6; display: flex; flex-direction: column; min-height: 100vh; }
        header { background: linear-gradient(90deg, var(--color-primario), var(--color-secundario)); color: var(--color-blanco); text-align: center; padding: 4rem 1rem; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; }
        header h1 { font-size: 2.8rem; font-weight: 600; margin-bottom: 0.5rem; }
        header p { font-size: 1.2rem; font-weight: 300; opacity: 0.9; }
        main { flex-grow: 1; display: flex; justify-content: center; align-items: center; padding: 2rem; }
        .card { background: var(--color-blanco); border-radius: 15px; box-shadow: var(--sombra-suave); max-width: 800px; width: 100%; display: flex; flex-direction: column; align-items: center; text-align: center; padding: 2.5rem; transition: transform 0.3s ease; }
        .card:hover { transform: translateY(-5px); }
        .card svg { max-width: 120px; margin-bottom: 1.5rem; color: var(--color-primario); }
        .card h2 { font-size: 1.8rem; color: var(--color-primario); margin-bottom: 1rem; }
        .card p { font-size: 1rem; max-width: 600px; }
        .card p strong { color: var(--color-secundario); }
        footer { text-align: center; padding: 1.5rem; color: #aaa; font-size: 0.9rem; }
        @media (max-width: 768px) { header { padding: 3rem 1rem; } header h1 { font-size: 2.2rem; } .card { padding: 2rem; } .card h2 { font-size: 1.5rem; } }

        /* --- ESTILOS DEL CHAT (MODIFICADOS) --- */
        #chat-bubble {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: var(--color-primario);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: transform 0.2s ease;
            z-index: 1000;
        }
        #chat-bubble:hover { transform: scale(1.1); }
        #chat-bubble svg { color: white; width: 32px; height: 32px; }
        
        #chat-window {
            position: fixed;
            bottom: 100px;
            right: 20px;
            /* --- 1. TAMAÑO AMPLIADO --- */
            width: 450px; 
            height: 600px;
            max-width: 90%;
            background: white;
            border-radius: 15px;
            box-shadow: var(--sombra-suave);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform: scale(0);
            transform-origin: bottom right;
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        #chat-window.open { transform: scale(1); }
        
        #chat-header {
            background: var(--color-primario);
            color: white;
            padding: 15px;
            font-weight: 600;
        }

        #chat-messages {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .message {
            padding: 10px 15px;
            border-radius: 20px;
            margin-bottom: 10px;
            max-width: 85%; /* Un poco más de ancho para los mensajes */
            line-height: 1.4;
            word-wrap: break-word; /* Para que las palabras largas no rompan el layout */
        }
        /* --- 3. ESTILOS PARA ENLACES --- */
        .bot-message a {
            color: #ffffff;
            font-weight: 600;
            text-decoration: underline;
        }
        .user-message {
            background-color: #eef2f8;
            color: var(--color-texto);
            align-self: flex-end;
        }
        .bot-message {
            background-color: var(--color-primario);
            color: white;
            align-self: flex-start;
        }
        
        #chat-input-container {
            display: flex;
            border-top: 1px solid #eee;
            padding: 10px;
            align-items: flex-end; /* Para alinear el botón correctamente con el textarea */
        }
        /* --- 2. ESTILOS PARA EL TEXTAREA --- */
        #chat-input {
            flex-grow: 1;
            border: none;
            padding: 10px;
            outline: none;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            resize: none; /* Evita que el usuario cambie el tamaño manualmente */
            line-height: 1.5;
            max-height: 120px; /* Límite para que no crezca indefinidamente */
            overflow-y: auto;
        }
        #send-button {
            border: none;
            background: var(--color-primario);
            color: white;
            padding: 10px 15px; /* Ajuste de padding */
            border-radius: 8px;
            cursor: pointer;
            margin-left: 10px;
            align-self: flex-end; /* Alinear el botón con la última línea del textarea */
        }
    </style>
</head>
<body>
    <!-- CONTENIDO DE LA PÁGINA (SIN CAMBIOS) -->
    <header>
        <h1>Asistente de Cartera Deteriorada BCI</h1>
        <p>Consulta información de clientes y reglas de cartera deteriorada de forma rápida y sencilla.</p>
    </header>
    <main>
        <div class="card">
            <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
            <h2>Consulta de Cartera Deteriorada</h2>
            <p>Nuestro asistente te ayuda a consultar información de clientes y reglas de cartera deteriorada. Puedes preguntar por <strong>RUT de clientes</strong>, <strong>reglas de negocio</strong> o solicitar <strong>exportar datos en CSV</strong>. ¡Inicia el chat en la esquina inferior derecha!</p>
        </div>
    </main>
    <footer>
        <p>&copy; 2025 Asistente de Cartera Deteriorada BCI | Todos los derechos reservados.</p>
    </footer>

    <!-- ===== INTERFAZ DEL CHAT Y JAVASCRIPT (MODIFICADOS) ===== -->

    <div id="chat-bubble">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"></path></svg>
    </div>

    <div id="chat-window">
        <div id="chat-header">Asistente Cartera Deteriorada</div>
        <div id="chat-messages">
            <div class="message bot-message">¡Hola! Soy tu asistente de cartera deteriorada. Puedo ayudarte con consultas de clientes por RUT, reglas de negocio o exportar datos. ¿En qué puedo ayudarte?</div>
        </div>
        <div id="chat-input-container">
            <!-- --- 2. CAMBIADO DE INPUT A TEXTAREA --- -->
            <textarea id="chat-input" placeholder="Escribe tu mensaje..." rows="1"></textarea>
            <button id="send-button">Enviar</button>
        </div>
    </div>

    <script>
        // ---- CONFIGURACIÓN ----
        const N8N_WEBHOOK_URL = 'https://webhook-processor-production-ccde.up.railway.app/webhook/cardet-webhook'; 

        // ---- LÓGICA DEL CHAT ----
        const chatBubble = document.getElementById('chat-bubble');
        const chatWindow = document.getElementById('chat-window');
        const messagesContainer = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input'); // Ahora es un <textarea>
        const sendButton = document.getElementById('send-button');

        const getSessionId = () => {
            let sessionId = localStorage.getItem('chatSessionId');
            if (!sessionId) {
                sessionId = Math.random().toString(36).substring(2, 15);
                localStorage.setItem('chatSessionId', sessionId);
            }
            return sessionId;
        };
        const sessionId = getSessionId();

        chatBubble.addEventListener('click', () => {
            chatWindow.classList.toggle('open');
        });

        // --- 3. NUEVA FUNCIÓN PARA HACER LOS LINKS CLICKEABLES ---
        const linkify = (text) => {
            const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
            // Reemplaza las URLs encontradas con etiquetas <a>
            return text.replace(urlRegex, url => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
        };

        const sendMessage = async () => {
            const userMessage = chatInput.value.trim();
            if (userMessage === '') return;

            addMessageToUI(userMessage, 'user-message');
            chatInput.value = '';
            // Resetea la altura del textarea después de enviar
            chatInput.style.height = 'auto';

            try {
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: userMessage,
                        sessionId: sessionId
                    })
                });

                if (!response.ok) {
                    throw new Error('Error en la respuesta de n8n.');
                }

                const data = await response.json();
                const botReply = data.output;
                
                if (botReply) {
                    addMessageToUI(botReply, 'bot-message');
                } else {
                    addMessageToUI('Lo siento, no he podido obtener una respuesta.', 'bot-message');
                }

            } catch (error) {
                console.error('Error al conectar con n8n:', error);
                addMessageToUI('Ha ocurrido un error de conexión. Inténtalo de nuevo.', 'bot-message');
            }
        };

        const addMessageToUI = (text, className) => {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', className);
            
            // --- 3. MODIFICADO PARA USAR LA FUNCIÓN linkify ---
            // Usamos innerHTML para que el navegador renderice las etiquetas <a>
            messageElement.innerHTML = linkify(text);

            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        };

        sendButton.addEventListener('click', sendMessage);

        // --- 2. LÓGICA MODIFICADA PARA EL TEXTAREA ---
        chatInput.addEventListener('keydown', (event) => {
            // Si se presiona Enter Y NO se presiona la tecla Ctrl, se envía el mensaje
            if (event.key === 'Enter' && !event.ctrlKey) {
                event.preventDefault(); // Previene el salto de línea por defecto
                sendMessage();
            }
            // Si se presiona Ctrl + Enter, el textarea hará su acción por defecto: un salto de línea.
        });

        // Opcional pero recomendado: Auto-ajustar la altura del textarea al escribir
        chatInput.addEventListener('input', () => {
            chatInput.style.height = 'auto'; // Resetea la altura
            chatInput.style.height = `${chatInput.scrollHeight}px`; // Ajusta la altura al contenido
        });
    </script>
</body>
</html>